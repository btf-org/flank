<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flank</title>
    <style>
      .font-family-monospace {
        font-family: monospace;
      }
      .white-space-pre {
        white-space: pre-line;
      }
      .p-1_25 {
        padding: 1.25rem;
      }
      .my-0_75 {
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .border-1 {
        border: 1px solid;
      }
      .border-color-black {
        border-color: black;
      }
      .font-size-1 {
        font-size: 1rem;
      }
      a {
        color: #0000ee;
        text-decoration: underline;
        cursor: pointer;
      }
      a:visited {
        color: #551a8b;
      }
      .overflow-x-scroll {
        overflow-x: scroll;
      }
      td {
        padding: 0px 1rem;
        white-space: nowrap;
      }
      th {
        text-align: left;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="p-1_25 font-family-monospace font-size-1">
    <script>
      let accumulatingResponse = "";
      let lastOutput = null;
      let sid = sessionStorage.getItem("sid");
      if (!sid) {
        sid = randomBase62Id();
        sessionStorage.setItem("sid", sid);
      }

      function randomBase62Id() {
        const bytes = new Uint8Array(8);
        crypto.getRandomValues(bytes);

        // Split into two 32-bit numbers: hi and lo
        let hi =
          ((bytes[0] << 24) | (bytes[1] << 16) | (bytes[2] << 8) | bytes[3]) >>>
          0;

        let lo =
          ((bytes[4] << 24) | (bytes[5] << 16) | (bytes[6] << 8) | bytes[7]) >>>
          0;

        const alphabet =
          "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        let out = "";

        // Manual 64-bit division by 62
        for (let i = 0; i < 11; i++) {
          // Combine hi + lo as a 64-bit value and divide by 62
          const rem = (((hi % 62) * (2 ** 32 % 62)) % 62) + (lo % 62);
          const digit = rem % 62;
          out = alphabet[digit] + out;

          // Compute new 64-bit value = floor((hi<<32 | lo) / 62)
          const newHi = Math.floor(hi / 62);
          const carry = hi % 62;
          const mid = carry * 2 ** 32 + lo;
          const newLo = Math.floor(mid / 62);

          hi = newHi;
          lo = newLo;
        }

        return out;
      }

      function run(cmd) {
        console.log(cmd);
        const lastContainer =
          document.body.children[document.body.children.length - 1];
        const lastInput = lastContainer.children[0];
        lastInput.value = cmd;
        const lastBtn = lastContainer.children[1];
        lastBtn.click();
      }

      async function longPoll() {
        const response = await fetch(window.location.origin + "/iflank", {
          method: "GET",
          headers: { "X-Session-ID": sid },
        });
        const thisText = await response.text();
        accumulatingResponse += thisText;

        if (thisText[thisText.length - 1] === "\0") {
          lastOutput.innerHTML = accumulatingResponse;
          accumulatingResponse = "";
          makeCommand();
        }

        longPoll();
      }

      function makeCommand(outputOnly = false) {
        const container = document.createElement("div");
        if (!outputOnly) {
          const input = document.createElement("input");
          const button = document.createElement("button");
          input.className = "font-family-monospace";
          button.textContent = "Send";
          button.addEventListener("click", sendCommand);
          container.appendChild(input);
          container.appendChild(button);
        }
        const output = document.createElement("div");
        output.className =
          "white-space-pre p-1_25 my-0_75 border-1 border-color-black overflow-x-scroll";
        container.appendChild(output);

        document.body.appendChild(container);
        lastOutput = output;
      }
      async function sendCommand(event) {
        const button = event.target;
        const container = button.parentElement;
        const [input, btn, output] = container.children;

        lastOutput.innerHTML = "Loading...";
        try {
          await fetch(window.location.origin + "/iflank", {
            method: "POST",
            headers: {
              "Content-Type": "text/plain",
              "X-Session-ID": sid,
            },
            body: input.value + "\n",
          });
        } catch (err) {
          lastOutput.textContent = "Error reaching server: " + err.message;
          return;
        }
        // makeCommand();
      }
      async function sendInitialRefresh() {
        const container =
          document.body.children[document.body.children.length - 1];

        try {
          console.log("init POST");
          await fetch(window.location.origin + "/iflank", {
            method: "POST",
            headers: { "X-Session-ID": sid },
            body: "refresh\n",
          });
        } catch (err) {
          console.error(err);
          lastOutput.textContent = "Error reaching server: " + err.message;
          return;
        }
      }
      async function setup() {
        makeCommand(true);
        await sendInitialRefresh();
        longPoll();
      }

      setup();
    </script>
  </body>
</html>
