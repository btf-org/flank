<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Flank</title>
    <style>
      .font-family-monospace {
        font-family: monospace;
      }
      .white-space-pre {
        white-space: pre-line;
      }
      .p-1_25 {
        padding: 1.25rem;
      }
      .my-0_75 {
        margin-top: 0.75rem;
        margin-bottom: 0.75rem;
      }
      .border-1 {
        border: 1px solid;
      }
      .border-color-black {
        border-color: black;
      }
      .font-size-1 {
        font-size: 1rem;
      }
      a {
        color: #0000ee;
        text-decoration: underline;
        cursor: pointer;
      }
      a:visited {
        color: #551a8b;
      }
      .overflow-x-scroll {
        overflow-x: scroll;
      }
      td {
        padding: 0px 1rem;
        white-space: nowrap;
      }
      th {
        text-align: left;
        white-space: nowrap;
      }
    </style>
  </head>
  <body class="p-1_25 font-family-monospace font-size-1">
    <div
      id="container"
      class="white-space-pre p-1_25 my-0_75 border-1 border-color-black overflow-x-scroll"
    ></div>
    <script>
      let accumulatingResponse = "";
      let accumulatingUrl = "";
      let state = "outside";
      let sid = sessionStorage.getItem("sid");
      if (!sid) {
        sid = randomBase62Id();
        sessionStorage.setItem("sid", sid);
      }

      function randomBase62Id() {
        const bytes = new Uint8Array(8);
        crypto.getRandomValues(bytes);

        // Split into two 32-bit numbers: hi and lo
        let hi =
          ((bytes[0] << 24) | (bytes[1] << 16) | (bytes[2] << 8) | bytes[3]) >>>
          0;

        let lo =
          ((bytes[4] << 24) | (bytes[5] << 16) | (bytes[6] << 8) | bytes[7]) >>>
          0;

        const alphabet =
          "0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz";
        let out = "";

        // Manual 64-bit division by 62
        for (let i = 0; i < 11; i++) {
          // Combine hi + lo as a 64-bit value and divide by 62
          const rem = (((hi % 62) * (2 ** 32 % 62)) % 62) + (lo % 62);
          const digit = rem % 62;
          out = alphabet[digit] + out;

          // Compute new 64-bit value = floor((hi<<32 | lo) / 62)
          const newHi = Math.floor(hi / 62);
          const carry = hi % 62;
          const mid = carry * 2 ** 32 + lo;
          const newLo = Math.floor(mid / 62);

          hi = newHi;
          lo = newLo;
        }

        return out;
      }

      async function run(cmd) {
        try {
          await fetch(window.location.origin + "/iflank", {
            method: "POST",
            headers: {
              "Content-Type": "text/plain",
              "X-Session-ID": sid,
            },
            body: cmd + "\n",
          });
        } catch (err) {
          console.error(err);
          const container = document.getElementById("container");
          container.textContent = "Error reaching server: " + err.message;
          return;
        }
      }

      async function longPoll() {
        const response = await fetch(window.location.origin + "/iflank", {
          method: "GET",
          headers: { "X-Session-ID": sid },
        });
        let thisText = await response.text();
        for (let i = 0; i < thisText.length; i++) {
          if (thisText[i] == "%" && thisText.startsWith("%PAGESTART%\n", i)) {
            accumulatingResponse = "";
            state = "insidePage";
            i += "%PAGESTART%\n".length - 1;
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%PAGEEND%\n", i)
          ) {
            const prevState = state;
            state = "outside";
            i += "%PAGEEND%\n".length - 1;
            if (prevState == "insidePage") {
              const container = document.getElementById("container");
              container.innerHTML = accumulatingResponse;
              accumulatingResponse = "";
            }
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%TABLEHEADSTART%\n", i)
          ) {
            accumulatingResponse = "";
            state = "insideTableHead";
            i += "%TABLEHEADSTART%\n".length - 1;
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%TABLEHEADEND%\n", i)
          ) {
            const prevState = state;
            state = "outside";
            i += "%TABLHEADEND%\n".length - 1;
            if (prevState == "insideTableHead") {
              const thead = document.getElementById("thead");
              thead.innerHTML = accumulatingResponse;
              accumulatingResponse = "";
            }
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%APPENDTRSTART%\n", i)
          ) {
            accumulatingResponse = "";
            state = "insideTableRowAppend";
            i += "%APPENDTRSTART%\n".length - 1;
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%APPENDTREND%\n", i)
          ) {
            const prevState = state;
            state = "outside";
            i += "%APPENDTREND%\n".length - 1;
            if (prevState == "insideTableRowAppend") {
              const tbody = document.getElementById("tbody");
              tbody.insertAdjacentHTML("beforeend", accumulatingResponse);
              accumulatingResponse = "";
            }
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%APPENDPAGEBODYSTART%\n", i)
          ) {
            accumulatingResponse = "";
            state = "insidePageBodyAppend";
            i += "%APPENDPAGEBODYSTART%\n".length - 1;
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%APPENDPAGEBODYEND%\n", i)
          ) {
            const prevState = state;
            state = "outside";
            i += "%APPENDPAGEBODYEND%\n".length - 1;
            if (prevState == "insidePageBodyAppend") {
              const pageBody = document.getElementById("pageBody");
              pageBody.insertAdjacentHTML("beforeend", accumulatingResponse);
              accumulatingResponse = "";
            }
          } else if (
            thisText[i] == "%" &&
            thisText.startsWith("%STREAMPAGEBODYSTART%\n", i)
          ) {
            accumulatingResponse = "";
            state = "insidePageBodyStream";
            i += "%STREAMPAGEBODYSTART%\n".length - 1;
          } else if (state.startsWith("inside")) {
            accumulatingResponse += thisText[i];
          }
        }
        if (state == "insideTableRowAppend") {
          let validHtml = "";
          let remainder = accumulatingResponse;
          for (let j = accumulatingResponse.length - 1; j >= 0; j--) {
            if (
              accumulatingResponse[j] === "\n" &&
              accumulatingResponse.endsWith("</tr>\n", j + 1)
            ) {
              validHtml = accumulatingResponse.slice(0, j + 1);
              remainder = accumulatingResponse.slice(j + 1);
              break;
            }
          }
          const tbody = document.getElementById("tbody");
          tbody.insertAdjacentHTML("beforeend", validHtml);
          accumulatingResponse = remainder;
        } else if (state == "insidePageBodyAppend") {
          const pageBody = document.getElementById("pageBody");
          pageBody.insertAdjacentHTML("beforeend", accumulatingResponse);
          accumulatingResponse = "";
        } else if (state == "insidePageBodyStream") {
          const pageBody = document.getElementById("pageBody");
          pageBody.insertAdjacentHTML("beforeend", accumulatingResponse);
          accumulatingResponse = "";
        }

        // history.pushState({}, "", "/derp");

        longPoll();
      }
      async function setup() {
        longPoll();
        run("refresh");
      }

      setup();
    </script>
  </body>
</html>
